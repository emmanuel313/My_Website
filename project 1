from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
import openai
import os
from dotenv import load_dotenv
import json

load_dotenv()
app = Flask(__name__)

openai.api_key = os.getenv("OPENAI_API_KEY")

# Load or create memory file
MEMORY_FILE = "memory.json"
if not os.path.exists(MEMORY_FILE):
    with open(MEMORY_FILE, "w") as f:
        json.dump({}, f)

def load_memory():
    with open(MEMORY_FILE, "r") as f:
        return json.load(f)

def save_memory(memory):
    with open(MEMORY_FILE, "w") as f:
        json.dump(memory, f)

@app.route("/whatsapp", methods=["POST"])
def whatsapp_reply():
    incoming_msg = request.values.get('Body', '')
    sender = request.values.get('From')
    memory = load_memory()

    if sender not in memory:
        memory[sender] = {"chat": []}

    # Add user input to memory
    memory[sender]["chat"].append({"role": "user", "content": incoming_msg})

    # Limit memory to last 5 messages
    memory[sender]["chat"] = memory[sender]["chat"][-5:]

    # Generate reply
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=memory[sender]["chat"]
    )
    reply = response.choices[0].message["content"]
    memory[sender]["chat"].append({"role": "assistant", "content": reply})

    save_memory(memory)

    # Send reply to WhatsApp
    twilio_response = MessagingResponse()
    twilio_response.message(reply)
    return str(twilio_response)

if __name__ == "__main__":
    app.run(debug=True)
OPENAI_API_KEY=sk-xxxxx
TWILIO_ACCOUNT_SID=ACxxxxxxxx
TWILIO_AUTH_TOKEN=your_token
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886
MY_NUMBER=whatsapp:+91your_number

